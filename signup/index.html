<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0052FF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>تسجيل الدخول</title>
<style>
  :root{--b:#0052ff;--i:#0f172a;--m:#5b6472;--l:#d5dbe5;--c:#ffffff}
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Tahoma,Arial,sans-serif;background:#fff;color:var(--i)}
  .sb{position:fixed;top:0;left:0;right:0;height:env(safe-area-inset-top,0px);background:var(--b);z-index:10;pointer-events:none}
  .sp{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:20}
  .dz{display:flex;gap:10px}
  .d{width:10px;height:10px;border-radius:50%;background:var(--b);animation:b 1.05s infinite}
  .d:nth-child(2){animation-delay:.16s}
  .d:nth-child(3){animation-delay:.32s}
  @keyframes b{0%,80%,100%{opacity:.35;transform:scale(.7)}40%{opacity:1;transform:scale(1)}}
  .sh{max-width:420px;margin:0 auto;padding:calc(env(safe-area-inset-top,0px) + 16px) 18px 24px}
  .tp{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .mk{width:36px;height:36px}
  .ln{color:var(--b);font-weight:600;text-decoration:none}
  .cd{background:var(--c);border:1px solid var(--l);border-radius:12px;padding:20px}
  .tt{font-size:20px;font-weight:700;margin-bottom:16px}
  .gp{margin-bottom:14px}
  .lb{display:block;font-size:14px;font-weight:600;color:#1f2937;margin-bottom:8px}
  .fd{width:100%;height:48px;border:1px solid var(--l);border-radius:8px;background:#fff;color:var(--i);font-size:15px;padding:0 12px;outline:none}
  .fd::placeholder{color:#9aa3af}
  select.fd{appearance:none;-webkit-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');background-repeat:no-repeat;background-position:left 12px center;padding-left:36px}
  .bn{width:100%;height:48px;border:0;border-radius:8px;background:var(--b);color:#fff;font-weight:600;font-size:15px;cursor:pointer}
  .bn[disabled]{opacity:.6;cursor:not-allowed}
  .fn{font-size:12px;color:var(--m);line-height:1.6;margin-top:14px;text-align:center}
  .fn a{color:var(--b);text-decoration:none}
  .qr{display:none;border:1px solid var(--l);border-radius:10px;overflow:hidden;background:#fff}
  .qi{position:relative;aspect-ratio:1/1;width:100%;display:block;background:#f6f7fa}
  .qi img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
  .qa{font-size:12px;color:#475569;text-align:center;padding:8px 6px;border-top:1px solid var(--l)}
  .up{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;height:44px;border:1px dashed var(--l);border-radius:10px;background:#fafbff;color:#334155;font-size:13px;cursor:pointer}
  .up input{display:none}
  .lk{margin-top:10px;font-size:13px;word-break:break-all}
  .lk a{color:#0b62ff;text-decoration:none}
</style>
</head>
<body>

<div class="sb"></div>

<div class="sp" id="sp">
  <div class="dz"><div class="d"></div><div class="d"></div><div class="d"></div></div>
</div>

<div id="app" style="display:none">
  <div class="sh">
    <div class="tp">
      <svg class="mk" viewBox="0 0 36 36"><circle cx="18" cy="18" r="18" fill="#0052ff"/><path d="M23.7 20.7a6.4 6.4 0 1 1 0-5.4h3.67a9.99 9.99 0 1 0 0 5.4H23.7z" fill="#fff"/></svg>
      <a class="ln" href="#">Sign up</a>
    </div>

    <div class="cd">
      <div class="tt">تسجيل الدخول</div>

      <div class="gp">
        <span class="lb">اختر المنصة</span>
        <select id="p" class="fd">
          <option value="" selected disabled>اختر المنصة</option>
          <option>LINEBET</option>
          <option>1XBET</option>
          <option>MELBET</option>
          <option>MEGAPARI</option>
          <option>STAKE</option>
          <option>MYSTAKE</option>
          <option>GOOOBET</option>
          <option>RISCOBET</option>
          <option>888STARZ</option>
        </select>
      </div>

      <div id="gid" class="gp">
        <span class="lb">أدخل الـ ID</span>
        <input id="u" class="fd" type="text" inputmode="numeric" pattern="[0-9]{4,15}" maxlength="15" placeholder="مثال: 1234567">
      </div>

      <div id="gq" class="gp qr">
        <div class="qi"><img id="qimg" alt="QR"></div>
        <label class="up">
          <svg width="16" height="16" viewBox="0 0 24 24"><path d="M12 16V8M8 12h8" fill="none" stroke="#334155" stroke-width="2" stroke-linecap="round"/></svg>
          ارفع صورة QR
          <input id="qin" type="file" accept="image/*" capture="environment">
        </label>
        <div class="qa">سيتم استخراج الرابط من الصورة وإظهاره هنا:</div>
        <div id="qlk" class="lk"></div>
      </div>

      <button id="go" class="bn" disabled>متابعة</button>

      <div class="fn">باستمرارك، فإنك توافق على <a href="#">سياسة الخصوصية</a> و<a href="#">سياسة ملفات الارتباط</a>.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  const sp=document.getElementById('sp'),app=document.getElementById('app');
  const p=document.getElementById('p'),u=document.getElementById('u'),go=document.getElementById('go');
  const gid=document.getElementById('gid'),gq=document.getElementById('gq'),qin=document.getElementById('qin'),qimg=document.getElementById('qimg'),qlk=document.getElementById('qlk');

  const show=()=>{sp.style.display='none';app.style.display='block'};
  if(document.readyState==='complete'){setTimeout(show,900)}else{addEventListener('load',()=>setTimeout(show,900))}

  function validate(){
    const v=p.value,qr=(v==='STAKE'||v==='MYSTAKE');
    if(qr){gid.style.display='none';gq.style.display='block';go.disabled=true}
    else {gq.style.display='none';gid.style.display='block';go.disabled=!(v && /^[0-9]{4,15}$/.test(u.value.trim()))}
  }
  p.addEventListener('change',validate);
  u.addEventListener('input',validate);

  function toCanvas(w,h){const c=('OffscreenCanvas'in window)?new OffscreenCanvas(w,h):document.createElement('canvas');c.width=w;c.height=h;return c}
  function toCtx(w,h){const c=toCanvas(w,h);return [c,c.getContext('2d',{willReadFrequently:true})]}

  function enhance(ctx,w,h){
    const img=ctx.getImageData(0,0,w,h),d=img.data;
    let min=255,max=0;
    for(let i=0;i<d.length;i+=4){const g=(d[i]*77+d[i+1]*150+d[i+2]*29)>>8;d[i]=d[i+1]=d[i+2]=g;if(g<min)min=g;if(g>max)max=g}
    const rng=Math.max(1,max-min);
    for(let i=0;i<d.length;i+=4){let g=((d[i]-min)*255/rng)|0;d[i]=d[i+1]=d[i+2]=g}
    const kx=[-1,0,1,-2,0,2,-1,0,1],ky=[-1,-2,-1,0,0,0,1,2,1];
    const out=new Uint8ClampedArray(d.length);
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        let sx=0,sy=0,pi=((y-1)*w+(x-1))*4,ki=0;
        for(let j=0;j<3;j++){
          for(let i2=0;i2<3;i2++){
            const v=d[pi+(i2+j*w)*4];
            sx+=v*kx[ki];sy+=v*ky[ki];ki++;
          }
        }
        const mag=Math.min(255,Math.hypot(sx,sy)|0);
        const idx=(x+y*w)*4;out[idx]=out[idx+1]=out[idx+2]=mag;out[idx+3]=255;
      }
    }
    for(let i=0;i<d.length;i+=4){d[i]=(d[i]*0.6+out[i]*0.4)|0;d[i+1]=d[i];d[i+2]=d[i]}
    ctx.putImageData(img,0,0);
  }

  function binarize(ctx,w,h){
    const img=ctx.getImageData(0,0,w,h),d=img.data,hist=new Array(256).fill(0);
    for(let i=0;i<d.length;i+=4)hist[d[i]]++;
    let total=0,sum=0;for(let t=0;t<256;t++){total+=hist[t];sum+=t*hist[t]}
    let sumB=0,wB=0,maxVar=0,thr=127;
    for(let t=0;t<256;t++){wB+=hist[t];if(!wB)continue;const wF=total-wB;if(!wF)break;sumB+=t*hist[t];const mB=sumB/wB,mF=(sum-sumB)/wF;const v=wB*wF*(mB-mF)*(mB-mF);if(v>maxVar){maxVar=v;thr=t}}
    for(let i=0;i<d.length;i+=4){const v=d[i]<thr?0:255;d[i]=d[i+1]=d[i+2]=v}
    ctx.putImageData(img,0,0);
  }

  function cropCenter(ctx,w,h,percent){
    const k=Math.max(0.5,Math.min(1,percent/100));
    const cw=(w*k)|0,ch=(h*k)|0,ox=((w-cw)/2)|0,oy=((h-ch)/2)|0;
    const [c2,x2]=toCtx(cw,ch);
    x2.drawImage(ctx.canvas,ox,oy,cw,ch,0,0,cw,ch);
    return x2;
  }

  function drawRot(ctx,w,h,deg,scale){
    const rad=deg*Math.PI/180;
    const tw=Math.max(220,Math.floor(w*scale)),th=Math.max(220,Math.floor(h*scale));
    const sin=Math.abs(Math.sin(rad)),cos=Math.abs(Math.cos(rad));
    const rw=(tw*cos+th*sin)|0,rh=(tw*sin+th*cos)|0;
    const [c2,x2]=toCtx(rw,rh);
    x2.translate(rw/2,rh/2);x2.rotate(rad);x2.drawImage(ctx.canvas,-tw/2,-th/2,tw,th);
    return x2;
  }

  function tryDecode(ctx){
    const w=ctx.canvas.width,h=ctx.canvas.height;
    const id=ctx.getImageData(0,0,w,h);
    const res=jsQR(id.data,w,h,{inversionAttempts:"attemptBoth"});
    return res&&res.data?res.data.trim():null;
  }

  async function robustDecode(img){
    const scales=[1,0.9,0.8,0.7,0.6,0.5,0.4];
    const crops=[96,92,88,84,80,72,64];
    const rots=[0,12,-12,24,-24,36,-36,48,-48,60,-60,75,-75,90,-90];
    const [c0,x0]=toCtx(img.naturalWidth,img.naturalHeight);
    x0.imageSmoothingEnabled=false;
    x0.drawImage(img,0,0,c0.width,c0.height);

    for(const crop of crops){
      const xc=cropCenter(x0,c0.width,c0.height,crop);
      enhance(xc,xc.canvas.width,xc.canvas.height);
      binarize(xc,xc.canvas.width,xc.canvas.height);
      for(const s of scales){
        for(const r of rots){
          const xr=drawRot(xc,xc.canvas.width,xc.canvas.height,r,s);
          const out=tryDecode(xr);
          if(out) return out;
        }
      }
    }
    return null;
  }

  function showResult(text){
    if(text){
      let url=text;
      if(!/^https?:\/\//i.test(url)) url='https://'+url;
      qlk.innerHTML='<a href="'+url+'" target="_blank" rel="noopener">'+url+'</a>';
      go.disabled=false;
    }else{
      qlk.textContent='تعذّر التعرف على QR. جرّب صورة أوضح، مع قصّ أقرب للكود وتقليل الانعكاس.';
      go.disabled=true;
    }
  }

  async function handleImage(src){
    qlk.textContent='جارِ قراءة الكود...';
    const im=new Image();
    im.onload=async()=>{const out=await robustDecode(im);showResult(out)};
    im.onerror=()=>{qlk.textContent='تعذّر تحميل الصورة'};
    im.src=src;
    qimg.src=src;
  }

  qin.addEventListener('change',e=>{
    const f=e.target.files&&e.target.files[0];if(!f)return;
    const r=new FileReader();r.onload=o=>handleImage(o.target.result);r.readAsDataURL(f);
  });
</script>
</body>
</html>
